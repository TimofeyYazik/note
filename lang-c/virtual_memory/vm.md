# Лекция: Виртуальная память

### Введение

Виртуальная память — это техника управления памятью, используемая операционными системами для обеспечения приложениям иллюзии наличия большого непрерывного блока адресов памяти, даже если физическая память (ОЗУ) значительно меньше.

### Проблемы, решаемые виртуальной памятью

1. **Изоляция процессов**:
    
    - Каждое приложение получает свое собственное адресное пространство, что предотвращает доступ одного процесса к памяти другого.
2. **Эффективное использование физической памяти**:
    
    - Позволяет запускать большее количество процессов, чем имеется физической памяти, путем перемещения редко используемых данных на диск
        
3. **Защита памяти**:
    
    - Обеспечивает защиту от неправильного доступа к памяти, предотвращая программные ошибки и вредоносное ПО от повреждения данных других процессов или ядра.

4. **Упрощение управления памятью**:
    
    - Упрощает программирование, позволяя разработчикам не беспокоиться о физических адресах памяти.
        
5. **Фрагментация программ в оперативной памяти**:
    
    - Виртуальная память позволяет эффективно решать проблемы фрагментации, поскольку каждый процесс работает в своем собственном виртуальном адресном пространстве, что устраняет необходимость для процессов занимать смежные области в физической памяти.

### Как работает виртуальная память

Виртуальная память использует комбинацию аппаратных и программных средств для управления памятью:

1. **Страничная организация памяти**:
    - Память разбивается на блоки фиксированного размера, называемые страницами (обычно 4KB).
    - Виртуальные адреса преобразуются в физические через таблицы страниц.
2. **Таблицы страниц**:
    - Каждому процессу соответствует своя таблица страниц, которая хранит сопоставление между виртуальными и физическими адресами.
        
    - Таблица страниц хранится в памяти, а ее часть может быть кэширована в специальных аппаратных буферах (TLB - Translation Lookaside Buffer) для ускорения доступа.
        

### Преобразование виртуальных адресов в физические

1. **Виртуальный адрес**:
    - Делится на два поля: номер страницы (высшие биты) и смещение внутри страницы (низшие биты).
2. **Преобразование адреса**:
    - Номер страницы используется для поиска в таблице страниц.
    - Таблица страниц возвращает номер фрейма в физической памяти.
    - Смещение добавляется к базовому адресу фрейма для получения полного физического адреса.
3. **Использование TLB**:
    - Для ускорения доступа используется TLB, кэширующий последние преобразования.
    - При промахе TLB производится обращение к таблице страниц в памяти.

### Обработка отсутствия страниц (Page Fault)

1. **Причины отсутствия страниц**:
    - Если нужная страница отсутствует в физической памяти, возникает прерывание отсутствия страницы.
2. **Обработка прерывания**:
    - Операционная система сохраняет состояние текущего процесса и ищет нужную страницу на диске.
    - Выгружает редко используемую страницу из памяти (если она занята).
    - Загружает нужную страницу в память и обновляет таблицу страниц.
    - Возобновляет выполнение процесса.

### Виртуальная память и swap

1. **Swap-файл (или swap-раздел)**:
    - Swap — это область на жестком диске или SSD, используемая для временного хранения данных, которые не помещаются в физическую память.
    - При нехватке ОЗУ редко используемые страницы выгружаются в swap, освобождая физическую память для более активных страниц.
2. **Использование swap**:
    - Позволяет системе работать с большими объемами данных, чем есть физической памяти.
    - Обратная сторона — замедление работы, так как доступ к диску значительно медленнее, чем к ОЗУ.

### Виртуальная память и производительность

1. **Замедление при частых промахах (Thrashing)**:
    - Частое выгрузка и загрузка страниц из-за недостатка физической памяти приводит к значительному замедлению работы.
2. **Оптимизация использования памяти**:
    - Современные операционные системы используют алгоритмы замещения страниц, такие как LRU (Least Recently Used) и другие для минимизации числа промахов.

### Заключение

Виртуальная память играет ключевую роль в современных компьютерных системах, обеспечивая эффективное и безопасное управление памятью. Она позволяет запускать большие и сложные приложения на системах с ограниченной физической памятью, улучшая общее использование ресурсов и надежность системы.